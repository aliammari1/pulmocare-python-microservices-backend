groups:
- name: service_alerts
  rules:
  - alert: ServiceDown
    expr: up{job="medapp-services"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service {{ $labels.instance }} is down"
      description: "Service {{ $labels.instance }} has been down for more than 1 minute"

  - alert: HighResponseTime
    expr: rate(reports_request_latency_seconds_sum[5m]) / rate(reports_request_latency_seconds_count[5m]) > 0.5
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High response time on {{ $labels.instance }}"
      description: "Service response time is above 500ms for the last 2 minutes"

  - alert: HighErrorRate
    expr: rate(reports_request_total{status=~"5.*"}[5m]) / rate(reports_request_total[5m]) > 0.05
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High error rate on {{ $labels.instance }}"
      description: "Service error rate is above 5% for the last 2 minutes"

  - alert: CircuitBreakerOpen
    expr: circuit_breaker_state{state="open"} > 0
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Circuit breaker open on {{ $labels.instance }}"
      description: "Circuit breaker for {{ $labels.service }} is in open state"

  - alert: ServiceDependencyFailure
    expr: service_dependency_health{status="DOWN"} > 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Service dependency failure on {{ $labels.instance }}"
      description: "Service {{ $labels.service }} dependency {{ $labels.dependency }} is not healthy"

  - alert: HighMemoryUsage
    expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Container memory usage is above 85% for the last 5 minutes"

  - alert: HighCPUUsage
    expr: (rate(container_cpu_usage_seconds_total[5m]) / container_spec_cpu_quota) > 0.85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage on {{ $labels.instance }}"
      description: "Container CPU usage is above 85% for the last 5 minutes"

  - alert: MongoDBConnectionFailure
    expr: mongodb_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "MongoDB connection failure on {{ $labels.instance }}"
      description: "MongoDB connection is down for more than 1 minute"

  - alert: RedisConnectionFailure
    expr: redis_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Redis connection failure on {{ $labels.instance }}"
      description: "Redis connection is down for more than 1 minute"

  - alert: RabbitMQConnectionFailure
    expr: rabbitmq_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "RabbitMQ connection failure on {{ $labels.instance }}"
      description: "RabbitMQ connection is down for more than 1 minute"

- name: rabbitmq_alerts
  rules:
  - alert: RabbitMQQueueGrowing
    expr: rabbitmq_queue_messages > 1000
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "RabbitMQ queue {{ $labels.queue }} is growing"
      description: "Queue {{ $labels.queue }} has over 1000 messages for 10 minutes."

  - alert: RabbitMQNoConsumers
    expr: rabbitmq_queue_consumers == 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "No consumers for RabbitMQ queue {{ $labels.queue }}"
      description: "Queue {{ $labels.queue }} has no consumers for 5 minutes."

- name: redis_alerts
  rules:
  - alert: RedisMemoryHigh
    expr: redis_memory_used_bytes / redis_total_system_memory_bytes > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Redis memory usage high"
      description: "Redis memory usage is above 80% for 5 minutes."

  - alert: RedisKeyEviction
    expr: rate(redis_evicted_keys_total[5m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Redis keys being evicted"
      description: "Redis is evicting keys due to memory pressure."

- name: xray_service_alerts
  rules:
  - alert: XRayAnalysisFailure
    expr: rate(xray_analysis_failures_total[5m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "X-Ray analysis failures detected"
      description: "X-Ray service is experiencing analysis failures."

  - alert: XRayProcessingDelay
    expr: xray_processing_queue_latency_seconds > 30
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "X-Ray processing delay"
      description: "X-Ray processing is taking longer than 30 seconds."

- name: knowledge_service_alerts
  rules:
  - alert: KnowledgeServiceHighLatency
    expr: rate(knowledge_query_duration_seconds_sum[5m]) / rate(knowledge_query_duration_seconds_count[5m]) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Knowledge service high latency"
      description: "Knowledge service queries are taking longer than 2 seconds on average."

  - alert: KnowledgeServiceErrors
    expr: rate(knowledge_query_errors_total[5m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Knowledge service errors detected"
      description: "Knowledge service is experiencing query errors."