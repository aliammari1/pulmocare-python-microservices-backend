name: Container Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - 'config/**'
      - '.github/workflows/container-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - 'config/**'
      - '.github/workflows/container-tests.yml'

jobs:
  test-containers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Create backend directory structure
        run: |
          # Changed directories from backend to services
          mkdir -p services/medecins
          mkdir -p services/ordonnances
          mkdir -p services/patients
          mkdir -p services/radiologues
          mkdir -p services/reports
          mkdir -p monitoring/otel
          touch monitoring/otel/otel-collector-config.yaml
          
      - name: Create test Dockerfiles
        run: |
          # Create simple Dockerfiles for testing in services directory
          for service in medecins ordonnances patients radiologues reports; do
            echo "FROM python:3.9-slim" > services/$service/Dockerfile
            echo "WORKDIR /app" >> services/$service/Dockerfile
            echo "COPY . ." >> services/$service/Dockerfile
            echo "RUN pip install fastapi uvicorn" >> services/$service/Dockerfile
            echo "CMD [\"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8080\"]" >> services/$service/Dockerfile
            
            # Create a minimal app for health check
            mkdir -p services/$service/app
            cat > services/$service/main.py << 'EOF'
          from fastapi import FastAPI
          
          app = FastAPI()
          
          @app.get("/health")
          def health_check():
              return {"status": "healthy"}
          EOF
          done
          
      - name: Build and test individual containers
        run: |
          for service in medecins ordonnances patients radiologues reports; do
            echo "Building $service container..."
            docker build -t medapp-$service:test ./services/$service
            
            if [ $? -ne 0 ]; then
              echo "Failed to build $service container"
              exit 1
            fi
          done
      
      - name: Run containers with docker-compose
        run: |
          # Use main docker-compose.yml instead of creating a custom file
          docker compose -f docker-compose.yml up -d
          
          echo "Waiting for core services to be healthy..."
          sleep 30
          
          docker ps
      
      - name: Run container health checks
        run: |
          # Create a health check script
          cat > health_check.sh << 'EOF'
          #!/bin/bash
          set -e
          
          declare -A SERVICE_PORTS=(
            ["mongodb"]="27017"
            ["redis"]="6379"
            ["rabbitmq"]="5672"
          )
          
          for service in "${!SERVICE_PORTS[@]}"; do
            echo "Checking $service..."
            if ! docker ps | grep -q "$service"; then
              echo "ERROR: $service container is not running!"
              exit 1
            fi
          done
          
          echo "All containers are running."
          exit 0
          EOF
          
          chmod +x health_check.sh
          ./health_check.sh
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.yml down
          docker system prune -f
