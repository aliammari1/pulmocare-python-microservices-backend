import os
import logging
from datetime import datetime
from typing import Optional

from fastapi import FastAPI, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from prometheus_client import Counter, Histogram, generate_latest, CONTENT_TYPE_LATEST
from opentelemetry import trace
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.resources import Resource
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor

from config import Config
from models.base import HealthCheckResponse, ServiceInfo
from routes.health import router as health_router
from routes.main import router as main_router
from middleware.logging import setup_logging
from middleware.tracing import setup_tracing

# Initialize logging
setup_logging()
logger = logging.getLogger(__name__)

# Initialize OpenTelemetry
setup_tracing("{{ service_name }}-service")

# Initialize FastAPI app
app = FastAPI(
    title="{{ service_description }}",
    description="{{ service_description }} for MedApp Platform",
    version="1.0.0",
    openapi_url="/api/v1/openapi.json",
    docs_url="/docs",
    redoc_url="/redoc"
)

# Prometheus metrics
REQUEST_COUNT = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status']
)

REQUEST_DURATION = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration in seconds',
    ['method', 'endpoint']
)

# Add security middleware
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=["*"]  # Configure for production
)

# Add CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=Config.CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allow_headers=["*"],
)

# Instrument FastAPI with OpenTelemetry
FastAPIInstrumentor.instrument_app(app)

# Middleware for metrics
@app.middleware("http")
async def metrics_middleware(request, call_next):
    start_time = datetime.now()
    
    response = await call_next(request)
    
    # Record metrics
    duration = (datetime.now() - start_time).total_seconds()
    REQUEST_COUNT.labels(
        method=request.method,
        endpoint=request.url.path,
        status=response.status_code
    ).inc()
    
    REQUEST_DURATION.labels(
        method=request.method,
        endpoint=request.url.path
    ).observe(duration)
    
    return response

# Service info endpoint
@app.get("/info", response_model=ServiceInfo, tags=["Service"])
async def get_service_info():
    """Get service information."""
    return ServiceInfo(
        name=Config.SERVICE_NAME,
        version="1.0.0",
        description="{{ service_description }}",
        environment=Config.ENV,
        port=Config.PORT,
        metrics_port=Config.METRICS_PORT
    )

# Metrics endpoint for Prometheus
@app.get("/metrics", tags=["Monitoring"])
async def get_metrics():
    """Prometheus metrics endpoint."""
    return generate_latest()

# Include routers
app.include_router(health_router, prefix="/api/v1", tags=["Health"])
app.include_router(main_router, prefix="/api/v1", tags=["{{ service_name.title() }}"])

# Startup event
@app.on_event("startup")
async def startup_event():
    logger.info(f"Starting {{ service_description }}...")
    logger.info(f"Service running on port {Config.PORT}")
    logger.info(f"Metrics available on port {Config.METRICS_PORT}")
    logger.info(f"Environment: {Config.ENV}")

# Shutdown event
@app.on_event("shutdown")
async def shutdown_event():
    logger.info(f"Shutting down {{ service_description }}...")

if __name__ == "__main__":
    import uvicorn
    
    uvicorn.run(
        "app:app",
        host=Config.HOST,
        port=Config.PORT,
        reload=Config.DEBUG,
        log_level="debug" if Config.DEBUG else "info",
        access_log=True
    )
