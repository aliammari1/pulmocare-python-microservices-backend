_format_version: "3.0"
_transform: true

# The configuration remains the same, but it will now be imported to the database
# rather than being used directly in DB-less mode

upstreams:
  - name: medecins-service-upstream
    targets:
      - target: medecins-service:8081
        weight: 100
    healthchecks:
      active:
        concurrency: 10
        healthy:
          interval: 5
          successes: 1
          http_statuses: [200, 302]
        unhealthy:
          interval: 5
          timeouts: 2
          http_failures: 2
          http_statuses: [429, 404, 500, 501, 502, 503, 504, 505]
        type: http
        http_path: /health
        timeout: 1
  - name: patients-service-upstream
    targets:
      - target: patients-service:8083
        weight: 100
    healthchecks:
      active:
        concurrency: 10
        healthy:
          interval: 5
          successes: 1
          http_statuses: [200, 302]
        unhealthy:
          interval: 5
          timeouts: 2
          http_failures: 2
          http_statuses: [429, 404, 500, 501, 502, 503, 504, 505]
        type: http
        http_path: /health
        timeout: 1
  - name: ordonnances-service-upstream
    targets:
      - target: ordonnances-service:8082
        weight: 100
    healthchecks:
      active:
        concurrency: 10
        healthy:
          interval: 5
          successes: 1
          http_statuses: [200, 302]
        unhealthy:
          interval: 5
          timeouts: 2
          http_failures: 2
          http_statuses: [429, 404, 500, 501, 502, 503, 504, 505]
        type: http
        http_path: /health
        timeout: 1
  - name: radiologues-service-upstream
    targets:
      - target: radiologues-service:8084
        weight: 100
    healthchecks:
      active:
        concurrency: 10
        healthy:
          interval: 5
          successes: 1
          http_statuses: [200, 302]
        unhealthy:
          interval: 5
          timeouts: 2
          http_failures: 2
          http_statuses: [429, 404, 500, 501, 502, 503, 504, 505]
        type: http
        http_path: /health
        timeout: 1
  - name: reports-service-upstream
    targets:
      - target: reports-service:8085
        weight: 100
    healthchecks:
      active:
        concurrency: 10
        healthy:
          interval: 5
          successes: 1
          http_statuses: [200, 302]
        unhealthy:
          interval: 5
          timeouts: 2
          http_failures: 2
          http_statuses: [429, 404, 500, 501, 502, 503, 504, 505]
        type: http
        http_path: /health
        timeout: 1
  - name: auth-service-upstream
    targets:
      - target: auth-service:8086
        weight: 100
    healthchecks:
      active:
        concurrency: 10
        healthy:
          interval: 5
          successes: 1
          http_statuses: [200, 302]
        unhealthy:
          interval: 5
          timeouts: 2
          http_failures: 2
          http_statuses: [429, 404, 500, 501, 502, 503, 504, 505]
        type: http
        http_path: /health
        timeout: 1

services:
  - name: medecins-service
    url: http://medecins-service:8081
    retries: 5
    connect_timeout: 1000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: medecins-auth
        paths:
          - /api/signup
          - /api/login
          - /api/forgot-password
          - /api/verify-otp
          - /api/reset-password
        strip_path: false
        methods:
          - POST
      - name: medecins-profile
        paths:
          - /api/profile
          - /api/change-password
          - /api/update-profile
          - /api/logout
        strip_path: false
      - name: medecins-special
        paths:
          - /api/scan-visit-card
          - /api/verify-doctor
          - /api/update-signature
        strip_path: false
      - name: medecins-api
        paths:
          - /api/medecins
        strip_path: false
        preserve_host: true

  - name: ordonnances-service
    url: http://ordonnances-service:8082
    routes:
      - name: ordonnances-main
        paths:
          - /api/ordonnances
        strip_path: false
      - name: ordonnances-specific
        paths:
          - /api/ordonnances/medecin
          - /api/ordonnances/ordonnance
        strip_path: false
      - name: ordonnances-verify
        paths:
          - /api/ordonnances/verify
        strip_path: false

  - name: patients-service
    url: http://patients-service:8083
    routes:
      - name: patients-auth
        paths:
          - /api/patient/signup
          - /api/patient/login
          - /api/patient/forgot-password
          - /api/patient/verify-otp
          - /api/patient/reset-password
        strip_path: false
        methods:
          - POST
      - name: patients-api
        paths:
          - /api/patients
          - /api/patient/list
        strip_path: false

  - name: radiologues-service
    url: http://radiologues-service:8084
    routes:
      - name: radiologues
        paths:
          - /api/v1/radiologues
        strip_path: false
        preserve_host: true

  - name: reports-service
    url: http://reports-service:8085
    routes:
      - name: reports-api
        paths:
          - /api/reports
        strip_path: false

  - name: auth-service
    url: http://auth-service:8086
    retries: 5
    connect_timeout: 1000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: auth-routes
        paths:
          - /api/auth
        strip_path: false
        preserve_host: true

plugins:
  - name: cors
    config:
      origins: ["*"]
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
      exposed_headers:
        - X-Auth-Token
        - X-Request-ID
        - X-Response-Time
      credentials: true
      max_age: 3600

  - name: rate-limiting
    config:
      minute: 60
      policy: redis
      redis:
        host: redis
        port: 6379
        password: ${REDIS_PASSWORD:-redispass}
        database: 0
        timeout: 2000

  - name: prometheus
    config:
      status_code_metrics: true
      latency_metrics: true
      upstream_health_metrics: true
      bandwidth_metrics: true

  # - name: jwt-keycloak
  #   service: auth-service
  #   config:
  #     wellknown_uri: http://keycloak:8080/realms/medapp/.well-known/openid-configuration
  #     claims_to_verify:
  #       - exp
  #     run_on_preflight: true
  #     maximum_expiration: 86400 # 24 hours

  # - name: openid-connect
  #   service: auth-service
  #   config:
  #     issuer: http://keycloak:8080/realms/medapp
  #     client_id: medapp-api
  #     client_secret: your-client-secret
  #     discovery: http://keycloak:8080/realms/medapp/.well-known/openid-configuration
  #     introspection_endpoint: http://keycloak:8080/realms/medapp/protocol/openid-connect/token/introspect
  #     token_endpoint: http://keycloak:8080/realms/medapp/protocol/openid-connect/token
  #     authorization_endpoint: http://keycloak:8080/realms/medapp/protocol/openid-connect/auth
  #     logout_endpoint: http://keycloak:8080/realms/medapp/protocol/openid-connect/logout
  #     userinfo_endpoint: http://keycloak:8080/realms/medapp/protocol/openid-connect/userinfo
  #     jwks_uri: http://keycloak:8080/realms/medapp/protocol/openid-connect/certs
  #     ssl_verify: false
  #     auth_methods:
  #       - authorization_code
  #       - password
  #       - client_credentials
  #       - refresh_token
  #     scope: openid email profile

  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid#counter
      echo_downstream: true

  - name: request-transformer
    config:
      add:
        headers:
          - X-Service-Version:${service.version}
          - X-Service-ID:${service.id}
          - X-Service-Name:${service.name}

  - name: response-transformer
    config:
      add:
        headers:
          - X-Kong-Upstream-Latency:${upstream_response_time}
          - X-Kong-Proxy:${kong.node.id}
