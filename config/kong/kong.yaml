_format_version: "3.0"
_transform: true

# Global plugins applied to all services
plugins:
  - name: cors
    config:
      origins: ["*"]
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
      exposed_headers:
        - X-Auth-Token
        - X-Request-ID
        - X-Response-Time
      credentials: true
      max_age: 3600

  - name: rate-limiting
    config:
      minute: 60
      policy: redis
      redis:
        host: redis
        port: 6379
        password: ${REDIS_PASSWORD:-redispass}
        database: 0
        timeout: 2000

  - name: prometheus
    config:
      status_code_metrics: true
      latency_metrics: true
      upstream_health_metrics: true
      bandwidth_metrics: true

  # Global OpenID Connect plugin configuration
  - name: openid-connect
    config:
      issuer: "http://keycloak:8080/auth/realms/medapp"
      client_id: ["medapp-api"]
      client_secret: ["${KEYCLOAK_CLIENT_SECRET:-your-client-secret}"]
      ssl_verify: false
      session_secret: "${OIDC_SESSION_SECRET:-mAjFkf86JuisaDs}"
      response_type: ["code"]
      bearer_token_param_type: ["header", "query"]
      scopes: ["openid", "email", "profile", "roles"]
      auth_methods: ["bearer", "session"]

  - name: jwt
    config:
      key_claim_name: "kid"
      claims_to_verify: ["exp"]
      run_on_preflight: true
      cookie_names: []
      header_names: ["Authorization"]

  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid#counter
      echo_downstream: true

services:
  # Auth service for Keycloak
  - name: auth-service
    url: http://keycloak:8080
    routes:
      - name: keycloak-auth
        paths:
          - /auth
        strip_path: false
        preserve_host: true

  # API Services with protected routes
  - name: medecins-service
    url: http://medecins-service:8081
    routes:
      - name: medecins-public
        paths:
          - /api/signup
          - /api/login
          - /api/forgot-password
        strip_path: false
        methods: ["POST", "OPTIONS"]
      - name: medecins-protected
        paths:
          - /api/medecins
          - /api/profile
        strip_path: false
        plugins:
          - name: openid-connect
            config:
              issuer: "http://keycloak:8080/auth/realms/medapp"
              client_id: ["medapp-api"]
              client_secret: ["${KEYCLOAK_CLIENT_SECRET:-your-client-secret}"]

  - name: patients-service
    url: http://patients-service:8083
    routes:
      - name: patients-public
        paths:
          - /api/patient/signup
          - /api/patient/login
          - /api/patient/forgot-password
        strip_path: false
        methods: ["POST", "OPTIONS"]
      - name: patients-protected
        paths:
          - /api/patients
        strip_path: false
        plugins:
          - name: openid-connect
            config:
              issuer: "http://keycloak:8080/auth/realms/medapp"
              client_id: ["medapp-api"]
              client_secret: ["${KEYCLOAK_CLIENT_SECRET:-your-client-secret}"]

  - name: ordonnances-service
    url: http://ordonnances-service:8082
    routes:
      - name: ordonnances-protected
        paths:
          - /api/ordonnances
        strip_path: false
        plugins:
          - name: openid-connect
            config:
              issuer: "http://keycloak:8080/auth/realms/medapp"
              client_id: ["medapp-api"]
              client_secret: ["${KEYCLOAK_CLIENT_SECRET:-your-client-secret}"]

  - name: radiologues-service
    url: http://radiologues-service:8084
    routes:
      - name: radiologues-protected
        paths:
          - /api/v1/radiologues
        strip_path: false
        plugins:
          - name: openid-connect
            config:
              issuer: "http://keycloak:8080/auth/realms/medapp"
              client_id: ["medapp-api"]
              client_secret: ["${KEYCLOAK_CLIENT_SECRET:-your-client-secret}"]

  - name: reports-service
    url: http://reports-service:8085
    routes:
      - name: reports-protected
        paths:
          - /api/reports
        strip_path: false
        plugins:
          - name: openid-connect
            config:
              issuer: "http://keycloak:8080/auth/realms/medapp"
              client_id: ["medapp-api"]
              client_secret: ["${KEYCLOAK_CLIENT_SECRET:-your-client-secret}"]

consumers:
  - username: keycloak
    custom_id: keycloak-integration
