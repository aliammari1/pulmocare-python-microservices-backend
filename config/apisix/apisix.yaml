consumers:
- plugins:
    key-auth:
      header_name: X-API-Key
      key: ${API_KEY}
  username: api_user
global_rules:
- id: 1
  plugins:
    prometheus:
      prefer_name: true
    response-rewrite:
      headers:
        set:
          Content-Security-Policy: default-src 'self'; frame-ancestors 'none'
          Strict-Transport-Security: max-age=31536000; includeSubDomains
          X-Content-Type-Options: nosniff
          X-Frame-Options: DENY
          X-XSS-Protection: 1; mode=block
routes:
- enable_websocket: false
  id: health-check
  name: service-health-checks
  plugins:
    prometheus:
      enable: true
    request-id:
      enable: true
      header_name: X-Request-Id
  upstream:
    nodes:
      auth-service:8086: 1
      medecins-service:8081: 1
      ordonnances-service:8082: 1
      patients-service:8083: 1
      radiologues-service:8084: 1
      reports-service:8085: 1
    type: roundrobin
  uri: /health
- id: auth-service
  name: auth-service
  plugins:
    cors:
      allow_credential: true
      allow_headers: Authorization,Content-Type,Accept
      allow_methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
      allow_origins: ${ALLOWED_ORIGINS}
      expose_headers: X-Request-Id
      max_age: 3600
    limit-req:
      burst: 20
      key: remote_addr
      rate: 10
      rejected_code: 429
    prometheus:
      enable: true
    request-id:
      enable: true
  upstream:
    checks:
      active:
        healthy:
          interval: 5
          successes: 2
        http_path: /health
        type: http
        unhealthy:
          http_failures: 3
          interval: 3
    nodes:
      auth-service:8086: 1
    type: roundrobin
  uri: /auth/*
- id: medecins-protected
  name: medecins-service
  plugins:
    cors:
      allow_credential: true
      allow_headers: Authorization,Content-Type,Accept
      allow_methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
      allow_origins: ${ALLOWED_ORIGINS}
      expose_headers: X-Request-Id
      max_age: 3600
    limit-count:
      count: 100
      key: remote_addr
      policy: redis
      rejected_code: 429
      time_window: 60
    openid-connect:
      bearer_only: true
      client_id: ${KEYCLOAK_CLIENT_ID}
      client_secret: ${KEYCLOAK_CLIENT_SECRET}
      discovery: ${KEYCLOAK_DISCOVERY_URL}
      ssl_verify: true
      timeout: 10
    prometheus:
      enable: true
  upstream:
    checks:
      active:
        healthy:
          interval: 5
          successes: 2
        http_path: /health
        type: http
        unhealthy:
          http_failures: 3
          interval: 3
    nodes:
      medecins-service:8081: 1
    type: roundrobin
  uri: /api/medecins/*
- id: patients-protected
  name: patients-service
  plugins:
    cors:
      allow_credential: true
      allow_headers: Authorization,Content-Type,Accept
      allow_methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
      allow_origins: ${ALLOWED_ORIGINS}
      expose_headers: X-Request-Id
      max_age: 3600
    limit-count:
      count: 100
      key: remote_addr
      policy: redis
      rejected_code: 429
      time_window: 60
    openid-connect:
      bearer_only: true
      client_id: ${KEYCLOAK_CLIENT_ID}
      client_secret: ${KEYCLOAK_CLIENT_SECRET}
      discovery: ${KEYCLOAK_DISCOVERY_URL}
      ssl_verify: true
      timeout: 10
  upstream:
    checks:
      active:
        healthy:
          interval: 5
          successes: 2
        http_path: /health
        type: http
        unhealthy:
          http_failures: 3
          interval: 3
    nodes:
      patients-service:8083: 1
    type: roundrobin
  uri: /api/patients/*
- id: reports-service
  name: reports-service
  plugins:
    cors:
      allow_credential: true
      allow_headers: Authorization,Content-Type,Accept
      allow_methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
      allow_origins: ${ALLOWED_ORIGINS}
      expose_headers: X-Request-Id
      max_age: 3600
    limit-count:
      count: 50
      key: remote_addr
      policy: redis
      rejected_code: 429
      time_window: 60
    openid-connect:
      bearer_only: true
      client_id: ${KEYCLOAK_CLIENT_ID}
      client_secret: ${KEYCLOAK_CLIENT_SECRET}
      discovery: ${KEYCLOAK_DISCOVERY_URL}
      ssl_verify: true
      timeout: 10
  upstream:
    checks:
      active:
        healthy:
          interval: 5
          successes: 2
        http_path: /health
        type: http
        unhealthy:
          http_failures: 3
          interval: 3
    nodes:
      reports-service:8085: 1
    type: roundrobin
  uri: /api/reports/*
